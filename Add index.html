<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±ªè¯æ—…ç¨‹è¦åŠƒèˆ‡åˆ†å¸³å„€è¡¨æ¿</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons (ä¿®æ­£ integrity å±¬æ€§) -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJzL31r+2K6zJTO4wQzHjGkM3L4l0J1W4X4r+V+fK6Z2S4N8S1C7Y6L6d5B5F3Q=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Google Fonts: Playfair Display for titles, Inter for body */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap');
        
        :root {
            --color-black: #111827;
            --color-gold: #D4AF37;
            --color-dark-gray: #374151;
            --color-light-gray: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-black);
            color: white;
            padding-bottom: 70px; /* Space for fixed bottom nav */
        }
        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-gold);
        }
        .luxury-card {
            background-color: var(--color-dark-gray);
            border-radius: 1rem; /* Large rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(212, 175, 55, 0.2); /* Subtle gold border */
        }
        .luxury-btn {
            background-color: var(--color-gold);
            color: var(--color-black);
            font-weight: 700;
            border-radius: 0.75rem;
            transition: transform 0.15s ease, opacity 0.15s ease;
            box-shadow: 0 4px 6px rgba(212, 175, 55, 0.4);
        }
        .luxury-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .luxury-input {
            background-color: var(--color-black);
            color: white;
            border: 1px solid var(--color-light-gray);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.15s ease;
        }
        .luxury-input:focus {
            border-color: var(--color-gold);
            outline: none;
        }

        /* Fixed Navigation */
        #bottom-nav {
            background-color: var(--color-black);
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            z-index: 50;
        }
        .nav-item.active {
            color: var(--color-gold);
            transform: translateY(-3px);
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.7);
        }
        
        /* Time highlight for PLAN */
        .highlight-time {
            color: #ff5733; /* Crimson Red for critical times */
            font-weight: 900;
        }
        
        /* Custom scrollbar for better aesthetics */
        .scroll-gold::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-gold::-webkit-scrollbar-thumb {
            background-color: var(--color-light-gray);
            border-radius: 3px;
        }
        .scroll-gold::-webkit-scrollbar-thumb:hover {
            background-color: var(--color-gold);
        }

        /* Loading spinner */
        .spinner {
            border-top-color: var(--color-gold);
            border-left-color: var(--color-gold);
            border-bottom-color: var(--color-dark-gray);
            border-right-color: var(--color-dark-gray);
        }

        /* è£œä¸Šé‡‘è‰²æ¨£å¼ Utilityï¼ˆtext-gold / bg-gold / border-goldï¼‰ */
        .text-gold {
            color: var(--color-gold);
        }
        .bg-gold {
            background-color: var(--color-gold);
            color: var(--color-black);
        }
        .border-gold {
            border-color: var(--color-gold);
        }
    </style>
</head>
<body>

    <!-- Main Content Container -->
    <div class="max-w-4xl mx-auto p-4 sm:p-6 pb-20">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl sm:text-4xl font-black tracking-wider">æ±äº¬é»‘é‡‘å°Šäº«ä¹‹æ—…</h1>
            <p class="text-sm text-gray-400 mt-1">æ‚¨çš„ç§äººæ—…ç¨‹å„€è¡¨æ¿</p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="app-content">
            <!-- Content will be rendered here -->
        </div>
    </div>

    <!-- Fixed Bottom Navigation for Mobile -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-16 flex justify-around items-center shadow-2xl">
        <button class="nav-item flex flex-col items-center p-2 text-sm text-gray-400 active" data-tab="plan">
            <i class="fas fa-calendar-alt text-lg"></i>
            <span class="mt-1">è¡Œç¨‹</span>
        </button>
        <button class="nav-item flex flex-col items-center p-2 text-sm text-gray-400" data-tab="guide">
            <i class="fas fa-map-marked-alt text-lg"></i>
            <span class="mt-1">å°è¦½</span>
        </button>
        <button class="nav-item flex flex-col items-center p-2 text-sm text-gray-400" data-tab="wallet">
            <i class="fas fa-wallet text-lg"></i>
            <span class="mt-1">è¨˜å¸³</span>
        </button>
        <button class="nav-item flex flex-col items-center p-2 text-sm text-gray-400" data-tab="lists">
            <i class="fas fa-clipboard-list text-lg"></i>
            <span class="mt-1">æ¸…å–®</span>
        </button>
        <button class="nav-item flex flex-col items-center p-2 text-sm text-gray-400" data-tab="info">
            <i class="fas fa-info-circle text-lg"></i>
            <span class="mt-1">è³‡è¨Š</span>
        </button>
    </nav>
    
    <!-- Modals -->
    <!-- AI Helper Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[100]">
        <div class="luxury-card w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-center mb-4 text-gold">AI è¡Œç¨‹è¦åŠƒèˆ‡æŸ¥è©¢</h3>
            <p class="text-gray-400 text-sm mb-4">ä½¿ç”¨ Google æœå°‹èˆ‡ AI ä¾†å„ªåŒ–è¡Œç¨‹æˆ–ç²å–å³æ™‚è³‡è¨Šã€‚ä¾‹å¦‚ï¼š`è«‹å¹«æˆ‘æŸ¥ä¸€ä¸‹éŠ€åº§é™„è¿‘æœ€é«˜è©•åƒ¹çš„å’Œç‰›é¤å»³`ã€‚</p>
            <textarea id="ai-query-input" rows="3" placeholder="è¼¸å…¥æ‚¨çš„æŸ¥è©¢..." class="luxury-input w-full mb-3"></textarea>
            
            <div class="flex space-x-3 mb-4">
                <button id="ai-query-btn" class="luxury-btn flex-1 py-2 flex items-center justify-center" disabled>
                    <i class="fas fa-search mr-2"></i> æŸ¥è©¢ (éœ€è¼‰å…¥API Key)
                </button>
                <button id="ai-close-btn" class="luxury-btn bg-gray-600 hover:bg-gray-700 text-white flex-1 py-2">
                    é—œé–‰
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="ai-loading" class="hidden text-center text-gray-300 py-4">
                <div class="spinner inline-block w-8 h-8 border-4 border-solid rounded-full animate-spin"></div>
                <p class="mt-2">AI æ­£åœ¨åŠªåŠ›è¦åŠƒä¸­...</p>
            </div>
            
            <!-- AI Response Area -->
            <div id="ai-response-area" class="mt-4 p-4 luxury-card bg-black border-l-4 border-gold scroll-gold max-h-60 overflow-y-auto">
                <p id="ai-response-text" class="whitespace-pre-wrap text-gray-300">AI çš„å›è¦†å°‡é¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
                <div id="ai-sources" class="mt-3 pt-2 border-t border-gray-700 text-xs text-gray-500"></div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[100]">
        <div class="luxury-card w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-center mb-4 text-gold">ç·¨è¼¯è¡Œç¨‹é …ç›®</h3>
            <form id="item-edit-form" class="space-y-3">
                <input type="hidden" id="edit-day-key">
                <input type="hidden" id="edit-item-id">

                <div class="flex space-x-3">
                    <input type="text" id="edit-day-display" readonly class="luxury-input flex-1 bg-gray-700 text-gray-400 cursor-not-allowed">
                    <input type="time" id="edit-item-time" required class="luxury-input flex-1">
                </div>
                
                <select id="edit-item-type" required class="luxury-input w-full">
                    <option value="" disabled>é¸æ“‡åˆ†é¡</option>
                    <!-- Options populated by JS -->
                </select>
                
                <input type="text" id="edit-item-desc" placeholder="è¡Œç¨‹æè¿°" required class="luxury-input w-full">

                <input type="text" id="edit-item-link" placeholder="åœ°åœ–é€£çµæˆ–æœå°‹é—œéµå­— (é¸å¡«)" class="luxury-input w-full">
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="edit-item-highlight" class="h-4 w-4 text-gold bg-gray-700 border-gray-600 rounded focus:ring-gold">
                        <label for="edit-item-highlight" class="ml-2 text-sm text-gray-400">è¨­ç‚ºé‡è¦/æé†’äº‹é …</label>
                    </div>
                    <button type="button" id="delete-edit-item-btn" class="text-red-500 hover:text-red-400 text-sm py-2 px-3 luxury-btn bg-red-900 bg-opacity-50">
                        <i class="fas fa-trash-alt mr-1"></i> åˆªé™¤æ­¤é …
                    </button>
                </div>

                <div class="flex space-x-3 pt-3">
                    <button type="submit" class="luxury-btn flex-1 py-2">
                        <i class="fas fa-save mr-2"></i> å„²å­˜è®Šæ›´
                    </button>
                    <button type="button" id="edit-close-btn" class="luxury-btn flex-1 py-2 bg-gray-600 hover:bg-gray-700 text-white">
                        å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- 1. GLOBAL STATE AND CONSTANTS ---
        
        // ** API Key (MUST be an empty string if using the Canvas environment) **
        const apiKey = ""; // ç•™ç©ºï¼Œè‹¥ä½ è¦çœŸçš„ä¸²æ¥ Gemini å†è‡ªè¡Œå¡«å…¥
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
        
        // Exchange Rate: JPY to TWD (Example: 1 JPY = 0.21 TWD)
        const DEFAULT_EXCHANGE_RATE = 0.21; 

        // Payment Methods for the new feature
        const PAYMENT_METHODS = ['ç¾é‡‘', 'ä¿¡ç”¨å¡', 'è¥¿ç“œå¡/ICå¡', 'è½‰å¸³', 'å…¶ä»–'];
        
        // Itinerary Categories
        const CATEGORIES = [
            { key: 'Attraction', name: 'æ™¯é»/åœ°æ¨™', icon: 'fa-archway', color: 'text-blue-400' },
            { key: 'Dining', name: 'é¤é£²/ç¾é£Ÿ', icon: 'fa-utensils', color: 'text-red-400' },
            { key: 'Activity', name: 'æ´»å‹•/é«”é©—', icon: 'fa-dice-d20', color: 'text-green-400' },
            { key: 'Shopping', name: 'è³¼ç‰©/è¡€æ‹¼', icon: 'fa-shopping-bag', color: 'text-purple-400' },
            { key: 'Travel', name: 'äº¤é€š/ç§»å‹•', icon: 'fa-car', color: 'text-yellow-400' },
            { key: 'Accommodation', name: 'ä½å®¿/ä¼‘æ†©', icon: 'fa-hotel', color: 'text-cyan-400' },
            { key: 'Other', name: 'å…¶ä»–/å‚™è¨»', icon: 'fa-info-circle', color: 'text-gray-400' }
        ];

        function getCategory(key) {
            return CATEGORIES.find(c => c.key === key) || CATEGORIES.find(c => c.key === 'Other');
        }

        // Initial Data Structure
        const INITIAL_STATE = {
            activeTab: 'plan',
            // --- WALLET DATA ---
            members: ["A", "B", "C"],
            expenses: [
                { id: Date.now(), desc: 'æ¸¬è©¦ï¼šA æ”¯ä»˜ $60', amount: 60, payer: 'A', splitBy: ['A', 'B', 'C'], currency: 'JPY', paymentMethod: 'ç¾é‡‘', timestamp: Date.now() - 2000 },
                { id: Date.now() + 1, desc: 'æ¸¬è©¦ï¼šB æ”¯ä»˜ $30 (ä¿¡ç”¨å¡)', amount: 30, payer: 'B', splitBy: ['A', 'B', 'C'], currency: 'JPY', paymentMethod: 'ä¿¡ç”¨å¡', timestamp: Date.now() - 1000 },
                { id: Date.now() + 2, desc: 'æ¸¬è©¦ï¼šC æ”¯ä»˜ $1000 å°å¹£', amount: 1000, payer: 'C', splitBy: ['A', 'C'], currency: 'TWD', paymentMethod: 'è½‰å¸³', timestamp: Date.now() },
            ],
            exchangeRate: DEFAULT_EXCHANGE_RATE, // TWD/JPY
            
            // --- LISTS DATA ---
            packingList: [
                { id: 1, text: 'è­·ç…§', checked: true },
                { id: 2, text: 'ç¶²å¡/eSIM', checked: true },
                { id: 3, text: 'é‡‘å¡/ä¿¡ç”¨å¡', checked: false },
                { id: 4, text: 'æ—…è¡Œæ–‡ä»¶', checked: true },
                { id: 5, text: 'ç²¾ç·»æœè£', checked: false },
                { id: 6, text: 'ç¾é‡‘ (æ—¥å¹£)', checked: true },
            ],
            memos: [
                { id: 1, text: 'ä»Šå¤©æ™šé¤æƒ³åƒå£½å–œç‡’' },
                { id: 2, text: 'é‡è¦ç¶²å€: https://example.com/tickets' },
            ],
            
            // --- ITINERARY DATA ---
            flightInfo: 'å»ç¨‹ï¼šæ˜Ÿå®‡èˆªç©º JX800 TPE(08:30) â†’ NRT(12:30)ï¼›å›ç¨‹ï¼šæ˜Ÿå®‡èˆªç©º JX801 NRT(18:00) â†’ TPE(21:00)',
            accommodationInfo: 'æ±äº¬éº—æ€å¡çˆ¾é “é…’åº— (The Ritz-Carlton, Tokyo)ï¼Œåœ°å€ï¼š9 Chome-7-1 Akasaka, Minato City, Tokyo',
            dailyItinerary: [
                { day: 'D1', date: 'Thu, Mar 12', items: [
                    { time: '12:30', desc: 'æŠµé” NRT æ©Ÿå ´', type: 'Travel', id: 101 },
                    { time: '13:30', desc: 'æŠµé”é…’åº—è¾¦ç†å…¥ä½ (é‡è¦)', highlight: true, type: 'Accommodation', id: 102 },
                    { time: '16:00', desc: 'å…­æœ¬æœ¨ä¹‹ä¸˜å±•æœ›å° (çœ‹æ—¥è½)', link: 'https://maps.app.goo.gl/RohtvS69f9XpG5p26', type: 'Attraction', id: 103 },
                    { time: '19:30', desc: 'Azabu-Juban è±ªè¯å£½å¸æ™šé¤', link: 'https://www.google.com/search?q=Azabu+Juban+luxury+sushi', type: 'Dining', id: 104 }
                ]},
                { day: 'D2', date: 'Fri, Mar 13', items: [
                    { time: '09:00', desc: 'åŒ…è»Šå‡ºç™¼å‰å¾€éŒå€‰ (é‡è¦)', highlight: true, type: 'Travel', id: 201 },
                    { time: '11:00', desc: 'éŒå€‰å¤§ä½›èˆ‡é•·è°·å¯º', link: 'https://maps.app.goo.gl/t9v4Wp8pGg9d4A3g6', type: 'Attraction', id: 202 },
                    { time: '14:00', desc: 'æ¹˜å—æµ·å²¸æ•£æ­¥', type: 'Activity', id: 203 },
                    { time: '18:00', desc: 'è¿”å›æ±äº¬ï¼Œåœ¨éŠ€åº§å“åšé ‚ç´šå’Œç‰›', link: 'https://www.google.com/search?q=Ginza+wagyu+restaurant', type: 'Dining', id: 204 }
                ]},
                { day: 'D3', date: 'Sat, Mar 14', items: [
                    { time: '10:00', desc: 'æ˜æ²»ç¥å®®åƒæ‹œ', type: 'Attraction', id: 301 },
                    { time: '13:00', desc: 'è¡¨åƒé“ç²¾å“è³¼ç‰©', type: 'Shopping', id: 302 },
                    { time: '16:00', desc: 'é’å±±è—è¡“å€å’–å•¡å»³ä¼‘æ¯', type: 'Activity', id: 303 },
                    { time: '19:00', desc: 'è¡¨åƒé“ç±³å…¶æ—æ³•é¤', highlight: true, type: 'Dining', id: 304 }
                ]},
                { day: 'D4', date: 'Sun, Mar 15', items: [
                    { time: '11:00', desc: 'ç¯‰åœ°å ´å¤–å¸‚å ´å°‹è¦“ç¾é£Ÿ', type: 'Dining', id: 401 },
                    { time: '15:00', desc: 'éŠ€åº§æ——è‰¦åº—è‡ªç”±è³¼ç‰©', type: 'Shopping', id: 402 },
                    { time: '19:00', desc: 'é«˜ç´šéµæ¿ç‡’æ™šé¤', type: 'Dining', id: 403 }
                ]},
                { day: 'D5', date: 'Mon, Mar 16', items: [
                    { time: '10:00', desc: 'ä¸Šé‡å…¬åœ’èˆ‡æ±äº¬åœ‹ç«‹åšç‰©é¤¨', type: 'Attraction', id: 501 },
                    { time: '14:00', desc: 'æ·ºè‰å¯ºèˆ‡ä»²è¦‹ä¸–é€šç´€å¿µå“è³¼è²·', type: 'Shopping', id: 502 },
                    { time: '18:00', desc: 'è¿”å›é…’åº—æ•´ç†è¡Œæ', highlight: true, type: 'Accommodation', id: 503 }
                ]},
                { day: 'D6', date: 'Tue, Mar 17', items: [
                    { time: '11:00', desc: 'é…’åº— Check-out', highlight: true, type: 'Accommodation', id: 601 },
                    { time: '12:00', desc: 'å‰å¾€æˆç”°æ©Ÿå ´ (NRT)', type: 'Travel', id: 602 },
                    { time: '18:00', desc: 'æ˜Ÿå®‡èˆªç©º JX801 å•Ÿç¨‹å›å°', type: 'Travel', id: 603 }
                ]}
            ]
        };

        let appData = {};

        // --- 2. LOCAL STORAGE UTILITIES ---

        function loadData() {
            try {
                const data = localStorage.getItem('luxuryTripData');
                let nextItineraryId = 1000;

                if (data) {
                    appData = JSON.parse(data);
                    appData.members = appData.members || INITIAL_STATE.members;
                    appData.expenses = (appData.expenses || INITIAL_STATE.expenses).map(exp => ({
                        ...exp,
                        currency: exp.currency || 'JPY',
                        paymentMethod: exp.paymentMethod || 'ç¾é‡‘'
                    }));
                    appData.dailyItinerary = (appData.dailyItinerary || INITIAL_STATE.dailyItinerary).map(day => ({
                        ...day,
                        items: day.items.map(item => ({
                            ...item,
                            type: item.type || 'Other',
                            id: item.id || nextItineraryId++
                        }))
                    }));
                    appData.packingList = appData.packingList || INITIAL_STATE.packingList;
                    appData.memos = appData.memos || INITIAL_STATE.memos;
                    appData.exchangeRate = appData.exchangeRate || INITIAL_STATE.exchangeRate;
                    appData.flightInfo = appData.flightInfo || INITIAL_STATE.flightInfo;
                    appData.accommodationInfo = appData.accommodationInfo || INITIAL_STATE.accommodationInfo;
                } else {
                    // ç”¨æ·±æ‹·è²é¿å…ç›´æ¥æ”¹åˆ° INITIAL_STATE æœ¬é«”
                    appData = JSON.parse(JSON.stringify(INITIAL_STATE));
                }
            } catch (e) {
                console.error("Error loading data from LocalStorage, using default:", e);
                appData = JSON.parse(JSON.stringify(INITIAL_STATE));
            }
        }

        function saveData() {
            try {
                localStorage.setItem('luxuryTripData', JSON.stringify(appData));
            } catch (e) {
                console.error("Error saving data to LocalStorage:", e);
            }
        }

        // --- 3. CORE LOGIC (EXPENSE SPLITTING) ---

        function round(value, decimals = 2) {
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        }

        function calculateSettlement(balances) {
            const settlement = [];
            const memberBalances = {};
            
            for (const [name, balance] of Object.entries(balances)) {
                if (Math.abs(round(balance)) > 0.005) { 
                    memberBalances[name] = round(balance);
                }
            }
            
            if (Object.keys(memberBalances).length === 0) {
                return settlement;
            }

            let iterations = 0;
            const MAX_ITERATIONS = 100;

            while (Object.keys(memberBalances).length >= 2 && iterations < MAX_ITERATIONS) {
                iterations++;
                
                let maxCreditorName = null;
                let maxCreditorBalance = -Infinity;
                let maxDebtorName = null;
                let maxDebtorBalance = Infinity;

                for (const [name, balance] of Object.entries(memberBalances)) {
                    if (balance > maxCreditorBalance) {
                        maxCreditorBalance = balance;
                        maxCreditorName = name;
                    }
                    if (balance < maxDebtorBalance) {
                        maxDebtorBalance = balance;
                        maxDebtorName = name;
                    }
                }
                
                if (Math.abs(maxCreditorBalance) < 0.005 && Math.abs(maxDebtorBalance) < 0.005) {
                    break;
                }

                const transferAmount = Math.min(maxCreditorBalance, -maxDebtorBalance);
                const roundedTransferAmount = round(transferAmount); 

                settlement.push({
                    from: maxDebtorName,
                    to: maxCreditorName,
                    amount: roundedTransferAmount
                });

                memberBalances[maxCreditorName] = round(memberBalances[maxCreditorName] - roundedTransferAmount);
                memberBalances[maxDebtorName] = round(memberBalances[maxDebtorName] + roundedTransferAmount);
                
                if (Math.abs(memberBalances[maxCreditorName]) < 0.005) {
                    delete memberBalances[maxCreditorName];
                }
                if (Math.abs(memberBalances[maxDebtorName]) < 0.005) {
                    delete memberBalances[maxDebtorName];
                }
            }
            
            return settlement;
        }

        // --- 4. IMAGE COMPRESSION & BASE64 ---

        function imageToBase64(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 200;
                    const scaleFactor = img.width > MAX_WIDTH ? MAX_WIDTH / img.width : 1;
                    
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 5. GOOGLE GEMINI API INTEGRATION ---

        async function fetchWithBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay.toFixed(0)}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        console.warn(`Fetch error: ${error.message}. Retrying...`);
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        async function handleGeminiQuery(query) {
            const loadingEl = document.getElementById('ai-loading');
            const responseTextEl = document.getElementById('ai-response-text');
            const sourcesEl = document.getElementById('ai-sources');
            
            responseTextEl.textContent = '';
            sourcesEl.innerHTML = '';
            loadingEl.classList.remove('hidden');

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—…éŠè¦åŠƒå¸«ï¼Œè«‹æ ¹æ“šæˆ‘çš„æŸ¥è©¢ï¼Œä»¥ç¹é«”ä¸­æ–‡æä¾›ç²¾æº–ä¸”å¯¦ç”¨çš„æ—…éŠå»ºè­°ã€‚å¦‚æœæŸ¥è©¢éœ€è¦å¤–éƒ¨è³‡è¨Šï¼Œè«‹ä½¿ç”¨ Google Search æä¾›çš„è³‡æ–™ï¼Œä¸¦åœ¨å›è¦†ä¸­å¼•ç”¨ä¾†æºã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let generatedText = 'æŠ±æ­‰ï¼Œæœªèƒ½ç²å–æœ‰æ•ˆçš„å›è¦†çµæ§‹ã€‚';
                let sources = [];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }

                responseTextEl.textContent = generatedText;
                if (sources.length > 0) {
                    sourcesEl.innerHTML = '<p class="font-bold mt-2">è³‡æ–™ä¾†æº:</p>';
                    sources.forEach(s => {
                        sourcesEl.innerHTML += `<a href="${s.uri}" target="_blank" class="block text-blue-400 hover:text-blue-200 truncate">${s.title}</a>`;
                    });
                } else {
                    sourcesEl.innerHTML = '<p class="text-gray-600">æ­¤å›è¦†ç„¡å¤–éƒ¨è³‡æ–™ä¾†æºå¼•ç”¨ã€‚</p>';
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                responseTextEl.textContent = `[éŒ¯èª¤] å‘¼å« AI æœå‹™å¤±æ•—ï¼š${error.message}ã€‚è«‹æª¢æŸ¥ API Key è¨­å®šæˆ–ç¶²è·¯é€£ç·šã€‚`;
                sourcesEl.innerHTML = '';
            } finally {
                loadingEl.classList.add('hidden');
            }
        }
        
        // --- 6. RENDERING FUNCTIONS ---
        
        const jpyFormatter = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' });
        const twdFormatter = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' });

        function renderTab(tabName) {
            const contentArea = document.getElementById('app-content');
            let html = '';

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });

            appData.activeTab = tabName;
            saveData();
            
            switch (tabName) {
                case 'plan':
                    html = renderPlanTab();
                    break;
                case 'guide':
                    html = renderGuideTab();
                    break;
                case 'wallet':
                    html = renderWalletTab();
                    break;
                case 'lists':
                    html = renderListsTab();
                    break;
                case 'info':
                    html = renderInfoTab();
                    break;
            }

            contentArea.innerHTML = html;
            attachEventListeners(tabName);
        }

        // --- A. PLAN TAB ---
        function renderPlanTab() {
            let itineraryHtml = '';
            appData.dailyItinerary.forEach(day => {
                let itemsHtml = day.items.map(item => {
                    const category = getCategory(item.type);
                    const timeClass = item.highlight ? 'highlight-time' : 'text-gray-300';

                    // ğŸ” æ”¹è‰¯ï¼šè‹¥ link æ˜¯é—œéµå­—ï¼Œå°±ç”¨ link ç•¶æœå°‹å­—ï¼›è‹¥æ˜¯ç¶²å€å°±ç›´æ¥é–‹ç¶²å€
                    const searchQuery = item.link && !item.link.startsWith('http')
                        ? item.link
                        : item.desc;

                    const linkButton = (item.link || searchQuery) ? `
                        <a href="${item.link && item.link.startsWith('http')
                                    ? item.link
                                    : 'https://www.google.com/search?q=' + encodeURIComponent(searchQuery)}" 
                           target="_blank" class="text-xs text-blue-400 hover:text-blue-300 ml-2">
                            <i class="fas fa-map-marker-alt"></i> åœ°åœ–/é£Ÿè¨˜
                        </a>
                    ` : '';

                    return `
                        <li class="mb-4 relative pl-8 border-l border-gray-600 group">
                            <span class="absolute -left-[10px] top-0 w-5 h-5 bg-gold rounded-full flex items-center justify-center text-black text-xs font-bold">${day.day.replace('D', '')}</span>
                            <div class="ml-2">
                                <span class="${timeClass} font-semibold text-sm block">${item.time}</span>
                                <p class="text-base text-white flex items-center justify-between">
                                    <span class="flex items-center">
                                        <i class="fas ${category.icon} ${category.color} mr-2 text-sm" title="${category.name}"></i>
                                        ${item.desc} ${linkButton}
                                    </span>
                                    <button data-day="${day.day}" data-id="${item.id}" class="edit-item-btn text-gray-500 hover:text-gold text-sm p-1 ml-4 transition duration-150">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </p>
                            </div>
                        </li>
                    `;
                }).join('');

                itineraryHtml += `
                    <div class="mb-8 luxury-card p-4">
                        <h3 class="text-xl font-bold text-gold mb-3">${day.day} - ${day.date}</h3>
                        <ul class="list-none p-0 m-0">
                            ${itemsHtml}
                        </ul>
                    </div>
                `;
            });
            
            const itineraryFormHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ“ å¿«é€Ÿæ–°å¢è¡Œç¨‹é …ç›®</h3>
                    <form id="itinerary-form" class="space-y-3">
                        <div class="flex space-x-3">
                            <select id="item-day" required class="luxury-input flex-1">
                                <option value="" disabled selected>é¸æ“‡æ—¥æœŸ (Day)</option>
                                ${appData.dailyItinerary.map(day => `<option value="${day.day}">${day.day} (${day.date})</option>`).join('')}
                            </select>
                            
                            <input type="time" id="item-time" value="10:00" required class="luxury-input flex-1">
                        </div>
                        
                        <select id="item-type" required class="luxury-input w-full">
                            <option value="" disabled selected>é¸æ“‡åˆ†é¡ (æ™¯é»/åƒé£¯/äº¤é€š)</option>
                            ${CATEGORIES.map(cat => `<option value="${cat.key}">${cat.name}</option>`).join('')}
                        </select>
                        
                        <input type="text" id="item-desc" placeholder="è¡Œç¨‹æè¿° (ä¾‹å¦‚: éŠ€åº§å’Œç‰›æ™šé¤)" required class="luxury-input w-full">

                        <input type="text" id="item-link" placeholder="åœ°åœ–é€£çµæˆ–æœå°‹é—œéµå­— (é¸å¡«)" class="luxury-input w-full">
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="item-highlight" class="h-4 w-4 text-gold bg-gray-700 border-gray-600 rounded focus:ring-gold">
                            <label for="item-highlight" class="ml-2 text-sm text-gray-400">è¨­ç‚ºé‡è¦/æé†’äº‹é …</label>
                        </div>

                        <button type="submit" class="luxury-btn w-full py-2">
                            <i class="fas fa-calendar-plus mr-2"></i> æ–°å¢è¡Œç¨‹
                        </button>
                    </form>
                </div>
            `;

            return `
                <section>
                    <div class="luxury-card p-4 mb-6">
                        <h2 class="text-2xl font-bold mb-3 text-gold">èˆªç­èˆ‡ä½å®¿è³‡è¨Š</h2>
                        <div class="text-sm space-y-2">
                            <p class="border-b border-gray-700 pb-2"><i class="fas fa-plane text-gold mr-2"></i> ${appData.flightInfo}</p>
                            <p><i class="fas fa-hotel text-gold mr-2"></i> ${appData.accommodationInfo}</p>
                        </div>
                    </div>
                    
                    <button id="open-ai-modal" class="luxury-btn w-full py-3 mb-6 flex items-center justify-center">
                        <i class="fas fa-brain mr-2"></i> AI è¡Œç¨‹è¦åŠƒèˆ‡æŸ¥è©¢ (Google ç³»çµ±)
                    </button>
                    
                    ${itineraryFormHtml}

                    <h2 class="text-2xl font-bold mb-4 text-gold">æ¯æ—¥è¡Œç¨‹è¡¨</h2>
                    ${itineraryHtml}
                </section>
            `;
        }
        
        // --- B. GUIDE TAB ---
        function renderGuideTab() {
            return `
                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gold text-center">æ·±åº¦å°è¦½ - å¥¢è¯æ‰‹å†Š</h2>
                    
                    <div class="luxury-card p-5 mb-6">
                        <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">éŒå€‰å¤§ä½›ï¼šæ±æ–¹çš„éœè¬å·¨åƒ</h3>
                        <p class="text-sm text-gray-300 mb-4">
                            é€™å°Šé«˜é” 13.35 å…¬å°ºçš„é˜¿å½Œé™€ä½›åƒï¼Œæ˜¯ç¹¼å¥ˆè‰¯å¤§ä½›å¾Œæ—¥æœ¬ç¬¬äºŒå¤§ä½›ã€‚å®ƒæœ€åˆè¢«å®‰ç½®åœ¨æœ¨é€ ä½›æ®¿å…§ï¼Œä½†åœ¨ 15 ä¸–ç´€çš„æµ·å˜¯ä¸­è¢«æ²–æ¯€ï¼Œå¾æ­¤å¤§ä½›ä¾¿éœ²å¤©çŸ—ç«‹è‡³ä»Šã€‚åœ¨é»‘é‡‘çš„ç¾ä»£è¨­è¨ˆä¸­ï¼Œæˆ‘å€‘ä»èƒ½æ„Ÿå—åˆ°å®ƒç¶“æ­·é¢¨éœœçš„èŠåš´èˆ‡éœè¬ã€‚
                        </p>
                        
                        <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">å…­æœ¬æœ¨ä¹‹ä¸˜ï¼šæ±äº¬çš„è—è¡“å¿ƒè‡Ÿ</h3>
                        <p class="text-sm text-gray-300 mb-4">
                            å…­æœ¬æœ¨ä¹‹ä¸˜ä¸åƒ…æ˜¯è±ªè¯è³¼ç‰©ä¸­å¿ƒï¼Œæ›´æ˜¯æ£®ç¾è¡“é¤¨çš„æ‰€åœ¨åœ°ã€‚ç«™åœ¨å±•æœ›å°ä¸Šï¼Œæ‚¨å¯ä»¥é³¥ç°æ•´å€‹æ±äº¬ï¼Œç‰¹åˆ¥æ˜¯åœ¨æ—¥è½æ™‚åˆ†ï¼Œå¾ç¾ä»£å»ºç¯‰ç¾¤ä¸­é€å‡ºçš„é‡‘è‰²å¤•é™½ï¼Œèˆ‡æˆ‘å€‘çš„ã€Œé»‘é‡‘ã€ä¸»é¡Œå®Œç¾å‘¼æ‡‰ã€‚
                        </p>
                    </div>

                    <div class="luxury-card p-5">
                        <h3 class="text-xl font-bold text-gold mb-3">é’å±±/è¡¨åƒé“å€åŸŸåœ°åœ–</h3>
                        <iframe width="100%" height="300" 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=139.7077,35.6669,139.7157,35.6739&layer=mapnik&marker=35.6704,139.7117" 
                                style="border: 1px solid black; border-radius: 0.75rem;">
                        </iframe>
                        <small class="block text-center text-gray-400 mt-2">åœ°åœ–ä¸­å¿ƒç‚ºè¡¨åƒé“ç«™ï¼Œä¾›æ‚¨å°è¦½ç²¾å“è³¼ç‰©å€ã€‚</small>
                    </div>
                </section>
            `;
        }

        // --- C. WALLET TAB ---
        function renderWalletTab() {
            const balances = calculateBalances();
            const settlementData = calculateSettlement(balances);
            
            const calculatorHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ’¸ å³æ™‚åŒ¯ç‡æ›ç®— (JPY â†’ TWD)</h3>
                    <div class="flex flex-col space-y-2 mb-3">
                        <div class="flex items-center space-x-2">
                            <input type="number" id="exchange-rate-input" class="luxury-input w-24 text-center" 
                                   value="${appData.exchangeRate}" step="0.0001">
                            <span class="text-sm text-gray-400"> TWD/JPY (1 JPY = ${appData.exchangeRate} TWD)</span>
                            <button id="save-rate-btn" class="text-gold hover:text-white"><i class="fas fa-save"></i></button>
                        </div>
                        <input type="text" id="calc-input" placeholder="è¼¸å…¥æ—¥å¹£ç®—å¼ (e.g., 500+200*3)" class="luxury-input w-full">
                    </div>
                    <div class="flex justify-between items-center bg-black p-3 rounded-lg border border-gray-700">
                        <span class="text-sm text-gray-400">æ—¥å¹£ç¸½é¡ (JPY): <span id="calc-jpy" class="font-bold text-lg text-white">0</span></span>
                        <span class="text-sm text-gray-400">å°å¹£æ›ç®— (TWD): <span id="calc-twd" class="font-bold text-lg text-gold">0</span></span>
                    </div>
                    <button id="calc-btn" class="luxury-btn w-full py-2 mt-3">è¨ˆç®—</button>
                </div>
            `;
            
            const membersHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ‘¥ åœ˜å“¡åå–® (${appData.members.length} äºº)</h3>
                    <div id="member-list-container" class="flex flex-wrap gap-2 mb-3">
                        ${appData.members.map(name => `
                            <span class="inline-flex items-center px-3 py-1 bg-gray-700 text-gold text-sm rounded-full">
                                ${name}
                                <button data-name="${name}" class="delete-member-btn ml-2 -mr-1 text-gray-400 hover:text-white transition">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </span>
                        `).join('')}
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="member-name-input" placeholder="æ–°å¢åœ˜å“¡å§“å" class="luxury-input flex-grow">
                        <button id="add-member-btn" class="luxury-btn px-4 py-2 text-sm">æ–°å¢</button>
                    </div>
                </div>
            `;
            
            const balanceHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ’° åœ˜å“¡çµç®—é¤˜é¡ (JPY)</h3>
                    <div id="balance-list" class="space-y-3">
                        ${appData.members.length === 0 ? '<p class="text-gray-500 text-center">è«‹å…ˆæ–°å¢åœ˜å“¡ã€‚</p>' : 
                            Object.entries(balances).sort(([, a], [, b]) => b - a).map(([name, balance]) => {
                                const finalBalance = round(balance);
                                const isOwed = finalBalance > 0.005;
                                const isOwes = finalBalance < -0.005;
                                const balanceClass = isOwed ? 'text-green-400' : (isOwes ? 'text-red-400' : 'text-gray-400');
                                const sign = isOwes ? 'æ‡‰ä»˜ ' : (isOwed ? 'æ‡‰æ”¶ ' : '');
                                return `
                                    <div class="flex justify-between items-center p-2 rounded-lg bg-gray-700">
                                        <span class="text-white font-semibold">${name}</span>
                                        <span class="text-lg font-extrabold ${balanceClass}">
                                            ${sign} ${jpyFormatter.format(Math.abs(finalBalance)).replace('Â¥', '')} JPY
                                        </span>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                    <p class="mt-3 text-xs text-gray-400">æ­£æ•¸ï¼šæ‡‰æ”¶å› (ä»˜å¤ªå¤š)ï¼›è² æ•¸ï¼šæ‡‰ä»˜å› (æ¬ éŒ¢)</p>
                </div>
            `;
            
            const settlementHtml = `
                <div class="luxury-card p-4 mb-6 bg-yellow-900 bg-opacity-30 border-l-4 border-gold">
                    <h3 class="text-xl font-bold text-gold mb-3">âœ¨ æœ€å°è½‰å¸³å»ºè­° (JPY)</h3>
                    <div id="settlement-suggestions" class="space-y-3">
                        ${settlementData.length === 0 ? '<p class="text-center text-gray-400 py-2">æ‰€æœ‰é¤˜é¡å·²çµæ¸…ã€‚</p>' : 
                            settlementData.map(item => `
                                <div class="flex items-center justify-between p-2 rounded-lg bg-gray-800">
                                    <div class="text-sm">
                                        <span class="font-bold text-white">${item.from}</span>
                                        <i class="fas fa-long-arrow-alt-right text-gold mx-2"></i>
                                        <span class="font-bold text-white">${item.to}</span>
                                    </div>
                                    <span class="text-lg font-extrabold text-gold">
                                        ${jpyFormatter.format(item.amount).replace('Â¥', '')} JPY
                                    </span>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;

            const expenseFormHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ“ æ–°å¢è¨˜å¸³ç´€éŒ„</h3>
                    <form id="expense-form" class="space-y-3">
                        <input type="text" id="expense-desc" placeholder="å“é …æè¿°" required class="luxury-input w-full">
                        
                        <div class="flex space-x-3">
                            <input type="number" id="expense-amount" placeholder="é‡‘é¡" step="0.01" required class="luxury-input flex-1">
                            
                            <select id="expense-currency" required class="luxury-input flex-1">
                                <option value="JPY" selected>æ—¥å¹£ (JPY)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>

                            <select id="expense-payer" required class="luxury-input flex-1">
                                <option value="" disabled selected>èª°ä»˜çš„éŒ¢ï¼Ÿ</option>
                                ${appData.members.map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                        </div>

                        <select id="expense-method" required class="luxury-input w-full">
                            <option value="" disabled selected>é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                            ${PAYMENT_METHODS.map(method => `<option value="${method}">${method}</option>`).join('')}
                        </select>
                        
                        <div class="p-3 bg-gray-800 rounded-lg">
                            <label class="block text-sm font-medium text-gray-300 mb-2">èª°éœ€è¦åˆ†æ”¤ï¼Ÿ</label>
                            <div id="split-members-container" class="flex flex-wrap gap-x-4 gap-y-2">
                                ${appData.members.map((name, index) => `
                                    <div class="flex items-center">
                                        <input id="split-member-${index}" type="checkbox" name="split-member" value="${name}" checked
                                               class="h-4 w-4 text-gold bg-gray-700 border-gray-600 rounded focus:ring-gold">
                                        <label for="split-member-${index}" class="ml-2 text-sm text-gray-300">${name}</label>
                                    </div>
                                `).join('')}
                                ${appData.members.length === 0 ? '<p class="text-sm text-gray-500">è«‹å…ˆæ–°å¢åœ˜å“¡</p>' : ''}
                            </div>
                        </div>

                        <input type="file" id="expense-photo" accept="image/*" class="hidden">
                        <div class="flex space-x-3">
                            <button type="button" id="upload-photo-btn" class="luxury-btn py-2 flex-1 bg-gray-600 hover:bg-gray-700 text-white text-sm">
                                <i class="fas fa-camera mr-2"></i> æ‹ç…§/ä¸Šå‚³æ”¶æ“š
                            </button>
                            <button type="submit" class="luxury-btn py-2 flex-1 text-sm">
                                ç´€éŒ„èŠ±è²»
                            </button>
                        </div>
                        <p id="photo-status" class="text-sm text-gold mt-2 hidden">å·²æº–å‚™å¥½åœ–ç‰‡ï¼</p>
                        <input type="hidden" id="expense-photo-base64">
                    </form>
                </div>
            `;
            
            const expenseListHtml = `
                <div class="luxury-card p-4">
                    <h3 class="text-xl font-bold text-gold mb-3">ğŸ’µ è¨˜å¸³æ­·å²ç´€éŒ„ (${appData.expenses.length} ç­†)</h3>
                    <div id="expense-list" class="space-y-3 max-h-96 overflow-y-auto scroll-gold">
                        ${appData.expenses.length === 0 ? '<p class="text-center text-gray-500">å°šç„¡è¨˜å¸³ç´€éŒ„ã€‚</p>' : 
                            appData.expenses.sort((a, b) => b.timestamp - a.timestamp).map(exp => {
                                let equivalentAmount, equivalentCurrency, mainFormatter;
                                if (exp.currency === 'JPY') {
                                    mainFormatter = jpyFormatter;
                                    equivalentCurrency = 'TWD';
                                    equivalentAmount = round(exp.amount * appData.exchangeRate);
                                } else {
                                    mainFormatter = twdFormatter;
                                    equivalentCurrency = 'JPY';
                                    equivalentAmount = round(exp.amount / appData.exchangeRate);
                                }
                                
                                return `
                                    <div class="p-3 rounded-lg bg-gray-800 border-l-4 border-gray-600 flex justify-between items-center">
                                        <div class="flex items-start space-x-3 w-3/4">
                                            ${exp.photo ? `<img src="${exp.photo}" class="w-12 h-12 object-cover rounded-md shadow-lg" alt="æ”¶æ“šç¸®åœ–">` : ''}
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-semibold text-white truncate">${exp.desc}</p>
                                                <p class="text-xs text-gray-400">æ”¯ä»˜è€…: ${exp.payer} | åˆ†æ”¤: ${exp.splitBy.join(', ')}</p>
                                                <p class="text-xs text-gray-500">æ–¹å¼: ${exp.paymentMethod || 'N/A'}</p>
                                            </div>
                                        </div>
                                        <div class="text-right w-1/4">
                                            <p class="text-base font-bold text-gold">
                                                ${mainFormatter.format(exp.amount).replace('Â¥', '').replace('NT$', '')} ${exp.currency}
                                            </p>
                                            <p class="text-xs text-gray-400">
                                                ç´„ ${(equivalentCurrency === 'TWD' ? twdFormatter : jpyFormatter).format(equivalentAmount).replace('Â¥', '').replace('NT$', '')} ${equivalentCurrency}
                                            </p>
                                            <button data-id="${exp.id}" class="delete-expense-btn text-red-500 hover:text-red-400 text-xs mt-1">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;

            return `
                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gold text-center">WALLET - æ—…è²»ç®¡ç†ä¸­å¿ƒ</h2>
                    ${calculatorHtml}
                    ${membersHtml}
                    ${balanceHtml}
                    ${settlementHtml}
                    ${expenseFormHtml}
                    ${expenseListHtml}
                </section>
            `;
        }
        
        function calculateBalances() {
            const balances = {};
            appData.members.forEach(member => {
                balances[member] = 0;
            });

            const rate = appData.exchangeRate || 0;

            appData.expenses.forEach(exp => {
                let amount = exp.amount || 0;
                const payer = exp.payer;
                const splitMembers = exp.splitBy || [];
                const numSplitters = splitMembers.length;

                if (numSplitters === 0) return;

                if (exp.currency === 'TWD') {
                    if (rate > 0) {
                        amount = round(amount / rate, 2);
                    } else {
                        console.error("Exchange rate is zero or invalid, skipping TWD expense for balance calculation.");
                        return;
                    }
                }

                if (balances.hasOwnProperty(payer)) {
                    balances[payer] = round(balances[payer] + amount);
                }

                const rawShare = amount / numSplitters;
                const roundedShare = round(rawShare);
                const totalDebited = round(roundedShare * numSplitters, 2); 
                const residualError = amount - totalDebited;

                splitMembers.forEach(member => {
                    if (balances.hasOwnProperty(member)) {
                        balances[member] = round(balances[member] - roundedShare);
                    }
                });
                
                if (Math.abs(residualError) > 0.005 && balances.hasOwnProperty(payer)) {
                    balances[payer] = round(balances[payer] - residualError);
                }
            });
            return balances;
        }

        // --- D. LISTS TAB ---
        function renderListsTab() {
            const checklistHtml = `
                <div class="luxury-card p-4 mb-6">
                    <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">âœ… è¡Œå‰æº–å‚™æ¸…å–®</h3>
                    <ul id="packing-list-ul" class="space-y-2">
                        ${appData.packingList.map(item => `
                            <li class="flex items-center justify-between p-2 rounded-lg bg-gray-800">
                                <div class="flex items-center">
                                    <input type="checkbox" id="check-${item.id}" data-id="${item.id}" ${item.checked ? 'checked' : ''} 
                                           class="packing-checkbox h-4 w-4 text-gold bg-gray-700 border-gray-600 rounded focus:ring-gold">
                                    <label for="check-${item.id}" class="ml-3 text-white ${item.checked ? 'line-through text-gray-500' : ''}">${item.text}</label>
                                </div>
                                <button data-id="${item.id}" data-list="packing" class="delete-list-item-btn text-red-500 hover:text-red-400 text-sm">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </li>
                        }).join('')}
                    </ul>
                    <form id="add-packing-form" class="mt-4 flex space-x-2">
                        <input type="text" id="new-packing-item" placeholder="æ–°å¢æº–å‚™é …ç›®" class="luxury-input flex-grow">
                        <button type="submit" class="luxury-btn px-3 py-2 text-sm"><i class="fas fa-plus"></i></button>
                    </form>
                </div>
            `;
            
            const memoHtml = `
                <div class="luxury-card p-4">
                    <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">ğŸ“Œ å€‹äººå‚™å¿˜éŒ„</h3>
                    <ul id="memo-list-ul" class="space-y-2">
                        ${appData.memos.map(item => {
                            const isUrl = item.text.startsWith('http://') || item.text.startsWith('https://');
                            return `
                                <li class="p-3 rounded-lg bg-gray-800 flex justify-between items-start">
                                    <div class="flex-1 min-w-0 pr-4">
                                        <p class="text-sm text-white">${item.text}</p>
                                        ${isUrl ? `
                                            <a href="${item.text}" target="_blank" class="mt-1 luxury-btn inline-block py-1 px-3 text-xs">
                                                <i class="fas fa-external-link-alt mr-1"></i> é»æ“Šå‰å¾€é€£çµ
                                            </a>
                                        ` : ''}
                                    </div>
                                    <button data-id="${item.id}" data-list="memo" class="delete-list-item-btn text-red-500 hover:text-red-400 text-sm">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                    <form id="add-memo-form" class="mt-4 flex space-x-2">
                        <input type="text" id="new-memo-item" placeholder="æ–°å¢å‚™å¿˜éŒ„æˆ–ç¶²å€" class="luxury-input flex-grow">
                        <button type="submit" class="luxury-btn px-3 py-2 text-sm"><i class="fas fa-plus"></i></button>
                    </form>
                </div>
            `;

            return `
                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gold text-center">LISTS - æ¸…å–®èˆ‡å‚™å¿˜</h2>
                    ${checklistHtml}
                    ${memoHtml}
                </section>
            `;
        }

        // --- E. INFO TAB ---
        function renderInfoTab() {
            const emergencyContacts = [
                { name: 'æ—¥æœ¬å ±è­¦', number: '110', icon: 'fa-user-secret' },
                { name: 'æ—¥æœ¬æ•‘è­·è»Š/æ¶ˆé˜²', number: '119', icon: 'fa-ambulance' },
                { name: 'ä¸­è¯æ°‘åœ‹é§æ—¥ä»£è¡¨è™•', number: '+81-3-3280-7800', icon: 'fa-flag-usa' }
            ];

            const prohibitions = [
                'ç¦æ­¢æ”œå¸¶è‚‰è£½å“ã€æ–°é®®æ°´æœã€æ¤ç‰©å…¥å¢ƒ',
                'åœ¨å…¬å…±å ´æ‰€è«‹å‹¿å¤§è²å–§å˜©ï¼Œä¿æŒä½èª',
                'è«‹å‹¿åœ¨éå¸è¸å€å¸è¸',
                'éƒ¨åˆ†é¤å»³æˆ–è¨­æ–½ç¦æ­¢ç©¿æ‹–é‹é€²å…¥ (é«˜éšå ´æ‰€)'
            ];

            return `
                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gold text-center">INFO - é‡è¦æ—…éŠè³‡è¨Š</h2>
                    
                    <div class="luxury-card p-4 mb-6 flex justify-between items-center bg-gray-800">
                        <p class="text-white font-semibold"><i class="fas fa-cloud-sun text-gold mr-2"></i> ç•¶åœ°å¤©æ°£é å ±</p>
                        <a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="luxury-btn py-1 px-3 text-xs">
                            æ—¥æœ¬æ°£è±¡å»³ <i class="fas fa-external-link-alt ml-1"></i>
                        </a>
                    </div>
                    
                    <div class="luxury-card p-4 mb-6">
                        <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">ğŸš¨ ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                        <div class="space-y-3">
                            ${emergencyContacts.map(contact => `
                                <div class="flex items-center justify-between p-2 rounded-lg bg-red-900 bg-opacity-30 border-l-4 border-red-500">
                                    <p class="text-white font-semibold"><i class="fas ${contact.icon} text-red-500 mr-2"></i> ${contact.name}</p>
                                    <a href="tel:${contact.number}" class="text-lg text-red-400 hover:text-red-300 font-extrabold">${contact.number}</a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="luxury-card p-4">
                        <h3 class="text-xl font-bold text-gold mb-3 border-b border-gray-700 pb-2">âš ï¸ æ—…éŠç¦å¿Œèˆ‡æ³¨æ„äº‹é …</h3>
                        <ul class="list-disc list-inside space-y-2 text-sm text-gray-300">
                            ${prohibitions.map(item => `
                                <li class="text-white"><span class="text-gold font-bold mr-1">â€¢</span> ${item}</li>
                            `).join('')}
                        </ul>
                        <p class="mt-4 text-xs text-gray-500">å¿…å‚™æ¸…å–®ï¼š${appData.packingList.map(i => i.text).join('ã€')}</p>
                    </div>
                </section>
            `;
        }

        // --- 7. EVENT LISTENERS ---

        function attachEventListeners(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.onclick = () => renderTab(item.getAttribute('data-tab'));
            });
            
            if (tabName === 'plan') {
                const aiModal = document.getElementById('ai-modal');
                const aiQueryBtn = document.getElementById('ai-query-btn');
                
                document.getElementById('open-ai-modal').onclick = () => {
                    aiModal.style.display = 'flex';
                };
                document.getElementById('ai-close-btn').onclick = () => {
                    aiModal.style.display = 'none';
                };

                if (apiKey !== "") { 
                    aiQueryBtn.disabled = false;
                    aiQueryBtn.innerHTML = '<i class="fas fa-search mr-2"></i> æŸ¥è©¢';
                }

                aiQueryBtn.onclick = () => {
                    const query = document.getElementById('ai-query-input').value.trim();
                    if (query) {
                        handleGeminiQuery(query);
                    } else {
                        document.getElementById('ai-response-text').textContent = 'è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹ã€‚';
                    }
                };
                
                document.getElementById('itinerary-form').onsubmit = (e) => {
                    e.preventDefault();
                    
                    const dayKey = document.getElementById('item-day').value;
                    const time = document.getElementById('item-time').value;
                    const type = document.getElementById('item-type').value;
                    const desc = document.getElementById('item-desc').value.trim();
                    const link = document.getElementById('item-link').value.trim();
                    const highlight = document.getElementById('item-highlight').checked;
                    
                    if (!dayKey || !time || !type || !desc) {
                        console.error('è«‹å¡«å¯«å®Œæ•´çš„æ—¥æœŸã€æ™‚é–“ã€åˆ†é¡å’Œæè¿°ã€‚');
                        return;
                    }

                    const targetDay = appData.dailyItinerary.find(day => day.day === dayKey);

                    if (targetDay) {
                        const newItem = {
                            id: Date.now(),
                            time: time,
                            desc: desc,
                            type: type,
                            link: link || undefined,
                            highlight: highlight
                        };

                        targetDay.items.push(newItem);
                        targetDay.items.sort((a, b) => a.time.localeCompare(b.time));

                        saveData();
                        e.target.reset();
                        renderTab('plan');
                    } else {
                        console.error('æ‰¾ä¸åˆ°æŒ‡å®šçš„æ—¥æœŸï¼Œç„¡æ³•æ–°å¢è¡Œç¨‹ã€‚');
                    }
                };

                const editModal = document.getElementById('edit-item-modal');
                const editForm = document.getElementById('item-edit-form');
                const editTypeSelect = document.getElementById('edit-item-type');
                
                editTypeSelect.innerHTML = CATEGORIES.map(cat => `<option value="${cat.key}">${cat.name}</option>`).join('');

                document.querySelectorAll('.edit-item-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const dayKey = e.currentTarget.getAttribute('data-day');
                        const itemId = parseInt(e.currentTarget.getAttribute('data-id'));
                        
                        const dayData = appData.dailyItinerary.find(day => day.day === dayKey);
                        const itemData = dayData ? dayData.items.find(item => item.id === itemId) : null;

                        if (itemData) {
                            document.getElementById('edit-day-key').value = dayKey;
                            document.getElementById('edit-item-id').value = itemId;
                            document.getElementById('edit-day-display').value = `${dayData.day} - ${dayData.date}`;
                            document.getElementById('edit-item-time').value = itemData.time;
                            document.getElementById('edit-item-type').value = itemData.type;
                            document.getElementById('edit-item-desc').value = itemData.desc;
                            document.getElementById('edit-item-link').value = itemData.link || '';
                            document.getElementById('edit-item-highlight').checked = itemData.highlight || false;
                            
                            editModal.style.display = 'flex';
                        }
                    };
                });
                
                document.getElementById('edit-close-btn').onclick = () => {
                    editModal.style.display = 'none';
                };
                
                document.getElementById('delete-edit-item-btn').onclick = () => {
                    const dayKey = document.getElementById('edit-day-key').value;
                    const itemId = parseInt(document.getElementById('edit-item-id').value);

                    const targetDay = appData.dailyItinerary.find(day => day.day === dayKey);
                    if (targetDay) {
                        targetDay.items = targetDay.items.filter(item => item.id !== itemId);
                        saveData();
                        editModal.style.display = 'none';
                        renderTab('plan');
                    }
                };

                editForm.onsubmit = (e) => {
                    e.preventDefault();
                    
                    const dayKey = document.getElementById('edit-day-key').value;
                    const itemId = parseInt(document.getElementById('edit-item-id').value);

                    const targetDay = appData.dailyItinerary.find(day => day.day === dayKey);
                    const targetItem = targetDay ? targetDay.items.find(item => item.id === itemId) : null;

                    if (targetItem) {
                        targetItem.time = document.getElementById('edit-item-time').value;
                        targetItem.type = document.getElementById('edit-item-type').value;
                        targetItem.desc = document.getElementById('edit-item-desc').value.trim();
                        targetItem.link = document.getElementById('edit-item-link').value.trim() || undefined;
                        targetItem.highlight = document.getElementById('edit-item-highlight').checked;
                        
                        targetDay.items.sort((a, b) => a.time.localeCompare(b.time));

                        saveData();
                        editModal.style.display = 'none';
                        renderTab('plan');
                    }
                };
            }
            
            if (tabName === 'wallet') {
                document.getElementById('calc-btn').onclick = () => {
                    const inputEl = document.getElementById('calc-input');
                    const jpyEl = document.getElementById('calc-jpy');
                    const twdEl = document.getElementById('calc-twd');
                    
                    const raw = inputEl.value;
                    if (!/^[0-9+\-*/().\s]+$/.test(raw)) {
                        jpyEl.textContent = 'éŒ¯èª¤';
                        twdEl.textContent = 'åªå…è¨±æ•¸å­—èˆ‡ +-*/() ç¬¦è™Ÿ';
                        return;
                    }

                    try {
                        const result = Function('"use strict";return (' + raw + ')')();
                        const jpy = round(parseFloat(result));
                        jpyEl.textContent = jpyFormatter.format(jpy).replace('Â¥', '');
                        twdEl.textContent = twdFormatter.format(round(jpy * appData.exchangeRate));
                    } catch (e) {
                        jpyEl.textContent = 'éŒ¯èª¤';
                        twdEl.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆç®—å¼';
                    }
                };
                
                document.getElementById('save-rate-btn').onclick = () => {
                    const newRate = parseFloat(document.getElementById('exchange-rate-input').value);
                    if (!isNaN(newRate) && newRate > 0) {
                        appData.exchangeRate = newRate;
                        saveData();
                        renderTab('wallet');
                    }
                };
                
                document.getElementById('add-member-btn').onclick = () => {
                    const input = document.getElementById('member-name-input');
                    const name = input.value.trim();
                    if (name && !appData.members.map(m => m.toLowerCase()).includes(name.toLowerCase())) {
                        appData.members.push(name);
                        saveData();
                        input.value = '';
                        renderTab('wallet');
                    }
                };
                document.querySelectorAll('.delete-member-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const name = e.currentTarget.getAttribute('data-name');
                        console.log(`Attempting to remove member: ${name}`);
                        appData.members = appData.members.filter(m => m !== name);
                        appData.expenses.forEach(exp => {
                            exp.splitBy = exp.splitBy.filter(s => s !== name);
                        });
                        saveData();
                        renderTab('wallet');
                    };
                });
                
                const photoInput = document.getElementById('expense-photo');
                document.getElementById('upload-photo-btn').onclick = () => photoInput.click();
                
                photoInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        imageToBase64(file, (base64) => {
                            document.getElementById('expense-photo-base64').value = base64;
                            document.getElementById('photo-status').textContent = 'å·²æº–å‚™å¥½åœ–ç‰‡ï¼';
                            document.getElementById('photo-status').classList.remove('hidden');
                        });
                    }
                };
                
                document.getElementById('expense-form').onsubmit = (e) => {
                    e.preventDefault();
                    
                    const desc = document.getElementById('expense-desc').value.trim();
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const payer = document.getElementById('expense-payer').value;
                    const currency = document.getElementById('expense-currency').value;
                    const paymentMethod = document.getElementById('expense-method').value;
                    const photoBase64 = document.getElementById('expense-photo-base64').value;
                    
                    const splitCheckboxes = document.querySelectorAll('#split-members-container input[name="split-member"]:checked');
                    const splitBy = Array.from(splitCheckboxes).map(cb => cb.value);

                    if (!desc || isNaN(amount) || amount <= 0 || !payer || !paymentMethod || splitBy.length === 0) {
                        console.error('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ã€æè¿°ã€æ”¯ä»˜è€…ã€ä»˜æ¬¾æ–¹å¼ä¸¦é¸æ“‡è‡³å°‘ä¸€ä½åˆ†æ”¤è€…ã€‚');
                        return;
                    }
                    
                    const newExpense = {
                        id: Date.now(),
                        desc: desc,
                        amount: round(amount),
                        payer: payer,
                        splitBy: splitBy,
                        currency: currency,
                        paymentMethod: paymentMethod,
                        timestamp: Date.now(),
                        photo: photoBase64
                    };
                    
                    appData.expenses.push(newExpense);
                    saveData();
                    e.target.reset();
                    document.querySelectorAll('#split-members-container input[name="split-member"]').forEach(cb => cb.checked = true);
                    
                    document.getElementById('expense-photo-base64').value = '';
                    document.getElementById('photo-status').classList.add('hidden');
                    renderTab('wallet');
                };

                document.querySelectorAll('.delete-expense-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        console.log(`Attempting to delete expense ID: ${id}`);
                        appData.expenses = appData.expenses.filter(exp => exp.id !== id);
                        saveData();
                        renderTab('wallet');
                    };
                });
            }
            
            if (tabName === 'lists') {
                document.querySelectorAll('.packing-checkbox').forEach(checkbox => {
                    checkbox.onchange = (e) => {
                        const id = parseInt(e.target.getAttribute('data-id'));
                        const item = appData.packingList.find(i => i.id === id);
                        if (item) {
                            item.checked = e.target.checked;
                            saveData();
                            renderTab('lists');
                        }
                    };
                });
                
                document.getElementById('add-packing-form').onsubmit = (e) => {
                    e.preventDefault();
                    const input = document.getElementById('new-packing-item');
                    const text = input.value.trim();
                    if (text) {
                        appData.packingList.push({ id: Date.now(), text: text, checked: false });
                        saveData();
                        input.value = '';
                        renderTab('lists');
                    }
                };

                document.getElementById('add-memo-form').onsubmit = (e) => {
                    e.preventDefault();
                    const input = document.getElementById('new-memo-item');
                    const text = input.value.trim();
                    if (text) {
                        appData.memos.push({ id: Date.now(), text: text });
                        saveData();
                        input.value = '';
                        renderTab('lists');
                    }
                };

                document.querySelectorAll('.delete-list-item-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const id = parseInt(e.currentTarget.getAttribute('data-id'));
                        const listType = e.currentTarget.getAttribute('data-list');
                        console.log(`Attempting to delete list item ID: ${id} from ${listType}`);

                        if (listType === 'packing') {
                            appData.packingList = appData.packingList.filter(i => i.id !== id);
                        } else if (listType === 'memo') {
                            appData.memos = appData.memos.filter(i => i.id !== id);
                        }
                        saveData();
                        renderTab('lists');
                    };
                });
            }
        }

        // --- 8. INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderTab(appData.activeTab || 'plan');
        });

    </script>
</body>
</html>
